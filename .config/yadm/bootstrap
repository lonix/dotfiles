#!/bin/bash

# This script executes all executable files (excluding templates, editor backups, and .fish files)
# in the ~/.config/yadm/bootstrap.d directory when run.

set -eu

# Define the directory to look for bootstrap executables
bootstrap_dir="${BASH_SOURCE[0]}.d"

# Check if the bootstrap directory exists
if [[ ! -d "$bootstrap_dir" ]]; then
  echo "Error: bootstrap directory '$bootstrap_dir' not found" >&2
  exit 1
fi

# Find and sort all files in the bootstrap directory
find -L "$bootstrap_dir" -type f | sort | while IFS= read -r file; do
  # Check if the file is executable and does not match the exclusion patterns
  if [[ -x "$file" && ! "$file" =~ "##" && ! "$file" =~ "~$" && ! "$file" =~ .fish ]]; then
    # Try to execute the file, and exit with an error if it fails
    if ! "$file"; then
      echo "Error: bootstrap '$file' failed" >&2
      exit 1
    fi
  fi
done
